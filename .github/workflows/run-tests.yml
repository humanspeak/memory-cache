name: Run tests

permissions:
    contents: read

on:
    workflow_call:
    pull_request:
        branches:
            - main
            - '!dependabot/**'
        paths:
            - src/**
            - '!docs/**'
            - package.json
            - pnpm-lock.yaml
            - vite.config.*
            - tsconfig*.json
            - .github/workflows/run-tests.yml

concurrency:
    group: run-tests-${{ github.ref }}
    cancel-in-progress: true

jobs:
    unit-tests:
        runs-on: blacksmith-2vcpu-ubuntu-2404 # trunk-ignore(actionlint/runner-label)
        timeout-minutes: 10
        strategy:
            matrix:
                node-version: [20, 22, 24]
        steps:
            - name: Checkout
              uses: actions/checkout@v6 # zizmor: ignore[unpinned-uses]
              with:
                  persist-credentials: false
                  fetch-depth: 1

            - uses: pnpm/action-setup@v4 # zizmor: ignore[unpinned-uses]
              with:
                  version: 10

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v6 # zizmor: ignore[unpinned-uses]
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run build
              run: pnpm build

            - name: Run tests
              run: pnpm test

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4 # zizmor: ignore[unpinned-uses]
              with:
                  name: test-results-node-${{ matrix.node-version }}
                  path: |
                      coverage/**
                      junit-vitest.xml
                  if-no-files-found: ignore
                  retention-days: 7
